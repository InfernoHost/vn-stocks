name: Pull Request Validation

on:
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pylint
      
      - name: Lint with flake8
        run: |
          # Stop on critical errors
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Check code style (warnings only)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: false
      
      - name: Check Python imports
        run: |
          python -c "
          import importlib.util
          import sys
          
          modules = ['bot', 'config', 'database', 'market', 'market_simulator', 'team_detection', 'utils', 'graphing']
          failed = []
          
          for m in modules:
              if importlib.util.find_spec(m) is None:
                  failed.append(m)
                  print(f'❌ Cannot import {m}')
              else:
                  print(f'✓ {m}')
          
          if failed:
              print(f'\nFailed to import: {failed}')
              sys.exit(1)
          print('\nAll modules OK!')
          "
      
      - name: Validate config structure
        run: |
          python -c "
          import config
          
          # Required config attributes
          required = ['TEAMS', 'TEAM_TAGS', 'SPURS_PER_COG', 'MARKET_UPDATE_INTERVAL', 
                      'MESSAGE_COOLDOWN', 'ACTIVITY_DECAY', 'ACTIVITY_IMPACT']
          
          missing = [attr for attr in required if not hasattr(config, attr)]
          if missing:
              print(f'Missing config: {missing}')
              exit(1)
          
          # Validate TEAMS structure
          assert len(config.TEAMS) > 0, 'No teams defined'
          
          for symbol, team in config.TEAMS.items():
              required_keys = ['name', 'symbol', 'starting_price', 'volatility', 'role_name']
              missing_keys = [k for k in required_keys if k not in team]
              if missing_keys:
                  print(f'Team {symbol} missing: {missing_keys}')
                  exit(1)
              
              # Validate volatility range
              if not 0 <= team['volatility'] <= 1:
                  print(f'Team {symbol} volatility out of range: {team[\"volatility\"]}')
                  exit(1)
          
          print('Config validation passed!')
          "
      
      - name: Test database initialization
        run: |
          python -c "
          import asyncio
          import os
          import database
          
          async def test():
              # Use test database
              original_path = database.config.DB_PATH
              database.config.DB_PATH = 'test_economy.db'
              
              try:
                  await database.init_db()
                  print('✓ Database initialization successful')
                  
                  # Test player registration
                  success = await database.register_player(12345)
                  assert success, 'Failed to register player'
                  print('✓ Player registration works')
                  
                  # Test duplicate registration
                  success = await database.register_player(12345)
                  assert not success, 'Duplicate registration should fail'
                  print('✓ Duplicate registration blocked')
                  
                  print('\nDatabase tests passed!')
              finally:
                  database.config.DB_PATH = original_path
                  if os.path.exists('test_economy.db'):
                      os.remove('test_economy.db')
          
          asyncio.run(test())
          "
      
      - name: Check for common issues
        run: |
          echo "Checking for common issues..."
          
          # Check for hardcoded tokens/secrets
          if grep -rn "MTQ1MTIyMTU\|DISCORD_TOKEN=" --include="*.py" --exclude-dir=venv .; then
            echo "❌ Found hardcoded tokens!"
            exit 1
          fi
          
          # Check for print statements that should be logging
          if grep -rn "print(" --include="*.py" --exclude-dir=venv . | grep -v "bot.py" | grep -v "^#"; then
            echo "⚠️ Warning: Found print statements outside bot.py (consider using logging)"
          fi
          
          echo "✓ No critical issues found"
      
      - name: Generate summary
        if: always()
        run: |
          echo "### PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ All validation checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR is ready for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some validation checks failed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the issues above before requesting review." >> $GITHUB_STEP_SUMMARY
          fi
